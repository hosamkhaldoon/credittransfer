name: "SonarCloud - Code Quality Analysis"

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'Type of analysis'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - incremental
          - security-hotspots
      upload_results:
        description: 'Upload results to SonarCloud'
        required: false
        default: true
        type: boolean

env:
  DOTNET_VERSION: '8.0.x'
  SONAR_SCANNER_VERSION: '5.0.1.3006'
  BUILD_CONFIGURATION: Release

jobs:
  # Job 1: SonarCloud Analysis
  sonarcloud-analysis:
    name: "SonarCloud Code Analysis"
    runs-on: windows-latest
    timeout-minutes: 30

    permissions:
      pull-requests: read
      contents: read

    steps:
    - name: "ðŸ“¥ Checkout Code"
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Shallow clones should be disabled for better analysis

    - name: "ðŸ”§ Setup .NET"
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: "â˜• Setup Java 17"
      uses: actions/setup-java@v4
      with:
        java-version: 17
        distribution: 'zulu'

    - name: "ðŸ“¦ Cache SonarCloud Packages"
      uses: actions/cache@v4
      with:
        path: ~\sonar\cache
        key: ${{ runner.os }}-sonar
        restore-keys: ${{ runner.os }}-sonar

    - name: "ðŸ“¦ Cache NuGet Packages"
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/packages.lock.json') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: "ðŸ”§ Install SonarCloud Scanner"
      shell: powershell
      run: |
        dotnet tool install --global dotnet-sonarscanner --version ${{ env.SONAR_SCANNER_VERSION }}
        dotnet tool list -g

    - name: "ðŸ”§ Install Coverage Tools"
      shell: powershell
      run: |
        dotnet tool install --global dotnet-reportgenerator-globaltool
        dotnet tool install --global coverlet.console

    - name: "ðŸ” Begin SonarCloud Analysis"
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      shell: powershell
      run: |
        # Determine analysis parameters
        $analysisArgs = @()
        
        # Basic parameters
        $analysisArgs += "/k:""credittransfer-modern"""
        $analysisArgs += "/o:""virgin-group"""
        $analysisArgs += "/d:sonar.token=""$env:SONAR_TOKEN"""
        $analysisArgs += "/d:sonar.host.url=""https://sonarcloud.io"""
        
        # Project information
        $analysisArgs += "/d:sonar.projectName=""CreditTransfer.Modern"""
        $analysisArgs += "/d:sonar.projectVersion=""1.0.${{ github.run_number }}"""
        
        # Source code configuration
        $analysisArgs += "/d:sonar.sources=""src/"""
        $analysisArgs += "/d:sonar.tests=""tests/"""
        $analysisArgs += "/d:sonar.sourceEncoding=""UTF-8"""
        
        # Coverage configuration
        $analysisArgs += "/d:sonar.cs.opencover.reportsPaths=""**/coverage.opencover.xml"""
        $analysisArgs += "/d:sonar.cs.vstest.reportsPaths=""**/*.trx"""
        
        # Language-specific settings
        $analysisArgs += "/d:sonar.dotnet.excludeTestProjects=""true"""
        
        # Quality gate settings
        $analysisArgs += "/d:sonar.qualitygate.wait=""true"""
        
        # Pull request specific settings
        if ("${{ github.event_name }}" -eq "pull_request") {
          $analysisArgs += "/d:sonar.pullrequest.key=""${{ github.event.number }}"""
          $analysisArgs += "/d:sonar.pullrequest.branch=""${{ github.head_ref }}"""
          $analysisArgs += "/d:sonar.pullrequest.base=""${{ github.base_ref }}"""
        } else {
          $analysisArgs += "/d:sonar.branch.name=""${{ github.ref_name }}"""
        }
        
        # Analysis type specific settings
        if ("${{ inputs.analysis_type }}" -eq "security-hotspots") {
          $analysisArgs += "/d:sonar.analysis.mode=""preview"""
        }
        
        # Exclusions for generated code and third-party
        $analysisArgs += "/d:sonar.exclusions=""**/bin/**,**/obj/**,**/*.Designer.cs,**/GlobalAssemblyInfo.cs,**/AssemblyInfo.cs"""
        $analysisArgs += "/d:sonar.test.exclusions=""**/bin/**,**/obj/**"""
        $analysisArgs += "/d:sonar.coverage.exclusions=""**/Migrations/**,**/*Test*.cs,**/*Tests.cs,**/Program.cs,**/Startup.cs"""
        
        Write-Output "Starting SonarCloud analysis with parameters:"
        $analysisArgs | ForEach-Object { Write-Output "  $_" }
        
        dotnet sonarscanner begin @analysisArgs

    - name: "ðŸ”„ Restore Dependencies"
      shell: powershell
      run: |
        dotnet restore CreditTransfer.Modern.sln --verbosity minimal

    - name: "ðŸ—ï¸ Build Solution"
      shell: powershell
      run: |
        dotnet build CreditTransfer.Modern.sln `
          --configuration ${{ env.BUILD_CONFIGURATION }} `
          --no-restore `
          --verbosity minimal `
          /p:Platform="Any CPU"

    - name: "ðŸ§ª Run Tests with Coverage"
      shell: powershell
      run: |
        # Create test results directory
        New-Item -ItemType Directory -Force -Path "TestResults"
        
        # Run tests with coverage collection
        dotnet test CreditTransfer.Modern.sln `
          --configuration ${{ env.BUILD_CONFIGURATION }} `
          --no-build `
          --verbosity minimal `
          --logger "trx;LogFileName=TestResults.trx" `
          --results-directory "TestResults" `
          --collect:"XPlat Code Coverage" `
          --settings "tests/coverlet.runsettings" `
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover `
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.IncludeTestAssembly=false

    - name: "ðŸ“Š Generate Coverage Report"
      shell: powershell
      run: |
        # Find coverage files
        $coverageFiles = Get-ChildItem -Path "TestResults" -Recurse -Filter "coverage.opencover.xml"
        
        if ($coverageFiles.Count -gt 0) {
          Write-Output "Found coverage files:"
          $coverageFiles | ForEach-Object { Write-Output "  $($_.FullName)" }
          
          # Generate consolidated coverage report
          $coveragePaths = ($coverageFiles | ForEach-Object { $_.FullName }) -join ";"
          
          reportgenerator `
            -reports:$coveragePaths `
            -targetdir:"CoverageReport" `
            -reporttypes:"SonarQube;Cobertura;HtmlInline_AzurePipelines" `
            -verbosity:Info
            
          Write-Output "Coverage report generated successfully"
        } else {
          Write-Output "âš ï¸ No coverage files found"
        }

    - name: "ðŸ” End SonarCloud Analysis"
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      shell: powershell
      run: |
        dotnet sonarscanner end /d:sonar.token="$env:SONAR_TOKEN"

    - name: "ðŸ“‹ Upload Coverage Reports"
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: |
          CoverageReport/
          TestResults/
        retention-days: 30

    - name: "ðŸ“Š SonarCloud Quality Gate Check"
      uses: sonarqube-quality-gate-action@master
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      timeout-minutes: 5

  # Job 2: Code Metrics Analysis
  code-metrics:
    name: "Code Metrics Analysis"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: "ðŸ“¥ Checkout Code"
      uses: actions/checkout@v4

    - name: "ðŸ”§ Setup .NET"
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: "ðŸ“Š Install Code Analysis Tools"
      run: |
        dotnet tool install --global Microsoft.CodeAnalysis.Metrics.Tool

    - name: "ðŸ”„ Restore Dependencies"
      run: dotnet restore CreditTransfer.Modern.sln --verbosity minimal

    - name: "ðŸ“ˆ Generate Code Metrics"
      run: |
        echo "Generating code metrics for all projects..."
        
        # Find all project files
        find . -name "*.csproj" -not -path "*/tests/*" -not -path "*/Test*" | while read -r project; do
          project_name=$(basename "$project" .csproj)
          echo "Analyzing project: $project_name"
          
          # Generate metrics for each project
          timeout 300s dotnet run --project "$project" --verbosity minimal || echo "Metrics generation completed or timed out for $project_name"
        done
        
        echo "Code metrics analysis completed"

    - name: "ðŸ“Š Complexity Analysis"
      run: |
        echo "=== Code Complexity Analysis ===" | tee complexity-analysis.txt
        echo "Analysis Date: $(date)" | tee -a complexity-analysis.txt
        echo "" | tee -a complexity-analysis.txt
        
        # Analyze C# files for complexity indicators
        echo "## File Count Analysis" | tee -a complexity-analysis.txt
        echo "Total C# files: $(find . -name "*.cs" -not -path "*/bin/*" -not -path "*/obj/*" | wc -l)" | tee -a complexity-analysis.txt
        echo "Source files: $(find ./src -name "*.cs" -not -path "*/bin/*" -not -path "*/obj/*" | wc -l)" | tee -a complexity-analysis.txt
        echo "Test files: $(find ./tests -name "*.cs" -not -path "*/bin/*" -not -path "*/obj/*" 2>/dev/null | wc -l)" | tee -a complexity-analysis.txt
        echo "" | tee -a complexity-analysis.txt
        
        echo "## Lines of Code Analysis" | tee -a complexity-analysis.txt
        total_lines=$(find ./src -name "*.cs" -not -path "*/bin/*" -not -path "*/obj/*" -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
        echo "Total lines of code: $total_lines" | tee -a complexity-analysis.txt
        echo "" | tee -a complexity-analysis.txt
        
        echo "## Large File Analysis (>500 lines)" | tee -a complexity-analysis.txt
        find ./src -name "*.cs" -not -path "*/bin/*" -not -path "*/obj/*" -exec wc -l {} + 2>/dev/null | \
          awk '$1 > 500 {print $1 " lines: " $2}' | head -10 | tee -a complexity-analysis.txt || echo "No large files found"
        
        echo "Code complexity analysis completed"

    - name: "ðŸ“‹ Upload Code Metrics"
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: code-metrics
        path: |
          complexity-analysis.txt
        retention-days: 30

  # Job 3: Technical Debt Analysis
  technical-debt:
    name: "Technical Debt Analysis"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: "ðŸ“¥ Checkout Code"
      uses: actions/checkout@v4

    - name: "ðŸ” TODO/FIXME Analysis"
      run: |
        echo "=== Technical Debt Analysis ===" | tee technical-debt.txt
        echo "Analysis Date: $(date)" | tee -a technical-debt.txt
        echo "" | tee -a technical-debt.txt
        
        echo "## TODO Items" | tee -a technical-debt.txt
        grep -r "TODO\|FIXME\|HACK\|BUG" --include="*.cs" ./src/ | head -20 | tee -a technical-debt.txt || echo "No TODO items found" | tee -a technical-debt.txt
        echo "" | tee -a technical-debt.txt
        
        echo "## TODO Summary" | tee -a technical-debt.txt
        todo_count=$(grep -r "TODO" --include="*.cs" ./src/ | wc -l || echo "0")
        fixme_count=$(grep -r "FIXME" --include="*.cs" ./src/ | wc -l || echo "0")
        hack_count=$(grep -r "HACK" --include="*.cs" ./src/ | wc -l || echo "0")
        
        echo "TODO items: $todo_count" | tee -a technical-debt.txt
        echo "FIXME items: $fixme_count" | tee -a technical-debt.txt
        echo "HACK items: $hack_count" | tee -a technical-debt.txt
        
        total_debt=$((todo_count + fixme_count + hack_count))
        echo "Total technical debt items: $total_debt" | tee -a technical-debt.txt

    - name: "ðŸ“‹ Upload Technical Debt Analysis"
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: technical-debt-analysis
        path: technical-debt.txt
        retention-days: 30

  # Job 4: Quality Summary
  quality-summary:
    name: "Code Quality Summary"
    runs-on: ubuntu-latest
    needs: [sonarcloud-analysis, code-metrics, technical-debt]
    if: always()

    steps:
    - name: "ðŸ“¥ Download Analysis Results"
      uses: actions/download-artifact@v4
      with:
        path: ./analysis-results

    - name: "ðŸ“Š Generate Quality Summary"
      run: |
        echo "# ðŸ“Š Code Quality Analysis Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“‹ Analysis Results" >> $GITHUB_STEP_SUMMARY
        echo "| Analysis Type | Status | Details |" >> $GITHUB_STEP_SUMMARY
        echo "|---------------|--------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| SonarCloud Analysis | ${{ needs.sonarcloud-analysis.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | Code quality and security analysis |" >> $GITHUB_STEP_SUMMARY
        echo "| Code Metrics | ${{ needs.code-metrics.result == 'success' && 'âœ… Passed' || (needs.code-metrics.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed') }} | Complexity and maintainability metrics |" >> $GITHUB_STEP_SUMMARY
        echo "| Technical Debt | ${{ needs.technical-debt.result == 'success' && 'âœ… Passed' || (needs.technical-debt.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed') }} | TODO/FIXME analysis |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # SonarCloud Results
        echo "## ðŸ” SonarCloud Analysis" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.sonarcloud-analysis.result }}" == "success" ]; then
          echo "âœ… **Quality Gate**: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š **View Results**: [SonarCloud Dashboard](https://sonarcloud.io/project/overview?id=credittransfer-modern)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” **Code Coverage**: Available in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›¡ï¸ **Security Analysis**: Completed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Quality Gate**: FAILED" >> $GITHUB_STEP_SUMMARY
          echo "- âš ï¸ Quality gate conditions not met" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š Check SonarCloud for detailed issues" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Code Metrics Summary
        if [ -f "./analysis-results/code-metrics/complexity-analysis.txt" ]; then
          echo "## ðŸ“ˆ Code Metrics Summary" >> $GITHUB_STEP_SUMMARY
          if grep -q "Total lines of code:" "./analysis-results/code-metrics/complexity-analysis.txt"; then
            loc=$(grep "Total lines of code:" "./analysis-results/code-metrics/complexity-analysis.txt" | awk '{print $5}')
            echo "- **Total Lines of Code**: $loc" >> $GITHUB_STEP_SUMMARY
          fi
          if grep -q "Total C# files:" "./analysis-results/code-metrics/complexity-analysis.txt"; then
            files=$(grep "Total C# files:" "./analysis-results/code-metrics/complexity-analysis.txt" | awk '{print $4}')
            echo "- **Total C# Files**: $files" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Technical Debt Summary
        if [ -f "./analysis-results/technical-debt-analysis/technical-debt.txt" ]; then
          echo "## âš ï¸ Technical Debt Summary" >> $GITHUB_STEP_SUMMARY
          if grep -q "Total technical debt items:" "./analysis-results/technical-debt-analysis/technical-debt.txt"; then
            debt=$(grep "Total technical debt items:" "./analysis-results/technical-debt-analysis/technical-debt.txt" | awk '{print $5}')
            echo "- **Total Technical Debt Items**: $debt" >> $GITHUB_STEP_SUMMARY
            
            if [ "$debt" -eq 0 ]; then
              echo "- ðŸŽ‰ **Status**: No technical debt detected!" >> $GITHUB_STEP_SUMMARY
            elif [ "$debt" -le 10 ]; then
              echo "- âœ… **Status**: Low technical debt" >> $GITHUB_STEP_SUMMARY
            elif [ "$debt" -le 25 ]; then
              echo "- âš ï¸ **Status**: Medium technical debt" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âŒ **Status**: High technical debt - requires attention" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Overall Quality Status
        if [ "${{ needs.sonarcloud-analysis.result }}" == "success" ]; then
          echo "## ðŸŽ‰ Overall Quality Status: âœ… EXCELLENT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Code quality analysis completed successfully. All quality gates passed." >> $GITHUB_STEP_SUMMARY
        else
          echo "## âš ï¸ Overall Quality Status: âŒ NEEDS IMPROVEMENT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Quality issues detected. Please review SonarCloud results and address the findings." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Review SonarCloud dashboard for detailed code quality metrics" >> $GITHUB_STEP_SUMMARY
        echo "2. Address any security hotspots or critical issues" >> $GITHUB_STEP_SUMMARY
        echo "3. Improve test coverage where needed (target: >80%)" >> $GITHUB_STEP_SUMMARY
        echo "4. Refactor complex methods to improve maintainability" >> $GITHUB_STEP_SUMMARY
        echo "5. Address technical debt items systematically" >> $GITHUB_STEP_SUMMARY