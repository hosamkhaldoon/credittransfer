# Generated by Cursor AI Assistant
name: "ğŸ³ Matrix Service Build"
description: "Build and optionally push Docker images for services using matrix strategy"

inputs:
  service-name:
    description: 'Service name (wcf, api, worker, web)'
    required: true
  service-display-name:
    description: 'Human-readable service name'
    required: true
  dockerfile-path:
    description: 'Path to Dockerfile'
    required: true
  context-path:
    description: 'Build context path'
    required: false
    default: './Migrated'
  image-name:
    description: 'Docker image name'
    required: true
  registry:
    description: 'Docker registry'
    required: false
    default: 'docker.io'
  push-image:
    description: 'Whether to push the image'
    required: false
    default: 'false'
  version-tag:
    description: 'Version tag for the image'
    required: false
    default: 'latest'
  registry-username:
    description: 'Registry username for push'
    required: false
  registry-password:
    description: 'Registry password for push'
    required: false

outputs:
  image-tag:
    description: 'Full image tag'
    value: ${{ steps.build.outputs.image-tag }}
  image-digest:
    description: 'Image digest'
    value: ${{ steps.build.outputs.digest }}
  build-success:
    description: 'Whether build was successful'
    value: ${{ steps.build.outputs.build-success }}

runs:
  using: composite
  steps:
    - name: "ğŸ” Validate Service Configuration"
      shell: bash
      run: |
        echo "ğŸ” Validating ${{ inputs.service-display-name }} configuration..."
        
        # Check if Dockerfile exists
        if [ ! -f "${{ inputs.dockerfile-path }}" ]; then
          echo "âŒ Dockerfile not found: ${{ inputs.dockerfile-path }}"
          echo "ğŸ” Available files in directory:"
          ls -la $(dirname "${{ inputs.dockerfile-path }}") || true
          exit 1
        fi
        
        # Check if context exists
        if [ ! -d "${{ inputs.context-path }}" ]; then
          echo "âŒ Build context not found: ${{ inputs.context-path }}"
          exit 1
        fi
        
        echo "âœ… Configuration valid for ${{ inputs.service-display-name }}"
        echo "ğŸ“ Dockerfile: ${{ inputs.dockerfile-path }}"
        echo "ğŸ“ Context: ${{ inputs.context-path }}"
        echo "ğŸ·ï¸ Image: ${{ inputs.image-name }}:${{ inputs.version-tag }}"

    - name: "ğŸ³ Setup Docker Buildx"
      uses: docker/setup-buildx-action@v3

    - name: "ğŸ” Login to Registry"
      if: inputs.push-image == 'true'
      uses: docker/login-action@v3
      with:
        registry: ${{ inputs.registry }}
        username: ${{ inputs.registry-username || github.repository_owner }}
        password: ${{ inputs.registry-password }}

    - name: "ğŸ“¦ Ensure Docker Hub repository exists"
      if: inputs.push-image == 'true' && inputs.registry == 'docker.io'
      shell: bash
      run: |
        set -e
        IMAGE_FULL="${{ inputs.image-name }}"
        NAMESPACE="${IMAGE_FULL%%/*}"
        REPO="${IMAGE_FULL##*/}"
        if [ -z "$NAMESPACE" ] || [ -z "$REPO" ] || [ "$NAMESPACE" = "$REPO" ]; then
          echo "âŒ Invalid image-name: $IMAGE_FULL (expected <namespace>/<repo>)"
          exit 1
        fi
        echo "ğŸ” Ensuring Docker Hub repo exists: $NAMESPACE/$REPO"
        if ! command -v jq >/dev/null 2>&1; then
          sudo apt-get update -y && sudo apt-get install -y jq >/dev/null 2>&1
        fi
        AUTH_USER='${{ inputs.registry-username || github.repository_owner }}'
        AUTH_PASS='${{ inputs.registry-password }}'
        if [ -z "$AUTH_USER" ] || [ -z "$AUTH_PASS" ]; then
          echo "âš ï¸ Missing Docker Hub credentials; cannot auto-create repository."
          exit 0
        fi
        TOKEN=$(curl -s -H "Content-Type: application/json" -X POST \
          -d "{\"username\": \"$AUTH_USER\", \"password\": \"$AUTH_PASS\"}" \
          https://hub.docker.com/v2/users/login/ | jq -r '.token')
        if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
          echo "âš ï¸ Failed to obtain Docker Hub JWT. Skipping repo creation."
          exit 0
        fi
        # Check existence
        EXISTS_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: JWT $TOKEN" \
          https://hub.docker.com/v2/repositories/$NAMESPACE/$REPO/)
        if [ "$EXISTS_CODE" = "200" ]; then
          echo "âœ… Repository already exists"
          exit 0
        fi
        echo "ğŸ†• Creating repository $NAMESPACE/$REPO on Docker Hub (public)"
        CREATE_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: JWT $TOKEN" \
          -H "Content-Type: application/json" -X POST https://hub.docker.com/v2/repositories/ \
          -d "{\"namespace\":\"$NAMESPACE\",\"name\":\"$REPO\",\"is_private\":false}")
        if [ "$CREATE_CODE" = "201" ] || [ "$CREATE_CODE" = "200" ]; then
          echo "âœ… Repository created or already available"
        else
          echo "âš ï¸ Failed to create repository (status $CREATE_CODE). Push may still succeed if repo exists."
        fi

    - name: "ğŸ·ï¸ Extract Metadata"
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ inputs.registry }}/${{ inputs.image-name }}
        tags: |
          type=raw,value=${{ inputs.version-tag }}
          type=raw,value=latest,enable={{is_default_branch}}
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-

    - name: "ğŸ”¨ Build and Push ${{ inputs.service-display-name }}"
      id: build
      uses: docker/build-push-action@v5
      with:
        context: ${{ inputs.context-path }}
        file: ${{ inputs.dockerfile-path }}
        push: ${{ inputs.push-image }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64
      continue-on-error: false

    - name: "ğŸ“Š Build Results"
      shell: bash
      run: |
        if [ "${{ steps.build.outcome }}" = "success" ]; then
          echo "build-success=true" >> $GITHUB_OUTPUT
          echo "image-tag=${{ fromJSON(steps.meta.outputs.json).tags[0] }}" >> $GITHUB_OUTPUT
          echo "digest=${{ steps.build.outputs.digest }}" >> $GITHUB_OUTPUT
          
          echo "âœ… ${{ inputs.service-display-name }} build successful!"
          echo "ğŸ·ï¸ Image: ${{ fromJSON(steps.meta.outputs.json).tags[0] }}"
          
          if [ "${{ inputs.push-image }}" = "true" ]; then
            echo "ğŸ“¤ Image pushed to registry"
            echo "ğŸ” Digest: ${{ steps.build.outputs.digest }}"
          else
            echo "ğŸ“¦ Image built locally (not pushed)"
          fi
        else
          echo "build-success=false" >> $GITHUB_OUTPUT
          echo "âŒ ${{ inputs.service-display-name }} build failed!"
          exit 1
        fi

    - name: "ğŸ” Image Inspection"
      if: steps.build.outputs.build-success == 'true'
      shell: bash
      run: |
        echo "ğŸ” Inspecting built image..."
        IMAGE_TAG="${{ fromJSON(steps.meta.outputs.json).tags[0] }}"
        
        # Get image info
        docker image inspect "$IMAGE_TAG" --format='Size: {{.Size}} bytes' || true
        docker image inspect "$IMAGE_TAG" --format='Created: {{.Created}}' || true
        docker image inspect "$IMAGE_TAG" --format='Architecture: {{.Architecture}}' || true
        
        echo "ğŸ“‹ Image layers:"
        docker history "$IMAGE_TAG" --no-trunc || true

    - name: "ğŸ“Š Update Build Summary"
      shell: bash
      run: |
        if [ "${{ steps.build.outputs.build-success }}" = "true" ]; then
          echo "| ${{ inputs.service-display-name }} | \`${{ fromJSON(steps.meta.outputs.json).tags[0] }}\` | âœ… Success |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ${{ inputs.service-display-name }} | \`${{ inputs.image-name }}:${{ inputs.version-tag }}\` | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
        fi