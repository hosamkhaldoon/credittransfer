# Generated by Cursor AI Assistant
name: "🔍 SonarQube Access - Modular Version"

on:
  push:
    branches: [ migrated ]
    paths:
      - 'Migrated/**'
      - '.github/workflows/sonarqube-access-modular.yml'
  workflow_dispatch:
    inputs:
      access_duration:
        description: 'How long to keep SonarQube accessible (minutes)'
        required: false
        default: '15'
        type: choice
        options:
          - '10'
          - '15'
          - '30'
          - '60'
      run_analysis:
        description: 'Run fresh analysis before opening access'
        required: false
        default: true
        type: boolean

env:
  SONAR_PROJECT_KEY: 'credit-transfer-modern'
  SONAR_PROJECT_NAME: "Credit Transfer Modern"
  ACCESS_DURATION: ${{ inputs.access_duration || '30' }}
  RUN_ANALYSIS: ${{ github.event_name == 'push' && 'true' || (inputs.run_analysis != false && 'true' || 'false') }}

jobs:
  # Use shared workflow for SonarQube analysis if needed
  sonarqube-analysis:
    name: "🔍 SonarQube Analysis"
    if: ${{ github.event_name == 'push' || inputs.run_analysis != false }}
    uses: ./.github/workflows/shared-sonarqube-analysis.yml
    with:
      project-key: 'credit-transfer-modern'
      project-name: "Credit Transfer Modern"
      working-directory: './Migrated'
      solution-file: 'CreditTransfer.Modern.sln'
      dotnet-version: '9.0.x'
    secrets:
      sonar-login: admin
      sonar-password: admin123

  # Public access setup using composite action
  setup-public-access:
    name: "🌐 Setup Public Access"
    runs-on: ubuntu-latest
    needs: [sonarqube-analysis]
    if: always()
    timeout-minutes: 90
    
    steps:
    - name: "📥 Checkout Code"
      uses: actions/checkout@v4

    - name: "🌐 Create Public Access via Ngrok"
      uses: ./.github/actions/setup-ngrok
      with:
        port: 9000
        auth-token: ${{ secrets.NGROK_AUTH_TOKEN }}
        duration-minutes: ${{ env.ACCESS_DURATION }}
        service-name: "SonarQube"
        service-url-path: "/dashboard?id=credit-transfer-modern"

  # Analysis summary and results
  summary:
    name: "📊 Access Summary"
    runs-on: ubuntu-latest
    needs: [sonarqube-analysis, setup-public-access]
    if: always()
    
    steps:
    - name: "📊 Generate Access Summary"
      run: |
        echo "## 🔍 SonarQube Access Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Analysis status
        if [ "${{ needs.sonarqube-analysis.result }}" = "success" ]; then
          echo "✅ **Fresh Analysis**: Completed successfully" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.sonarqube-analysis.result }}" = "skipped" ]; then
          echo "⏭️ **Fresh Analysis**: Skipped (existing data available)" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Fresh Analysis**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Access status
        if [ "${{ needs.setup-public-access.result }}" = "success" ]; then
          echo "✅ **Public Access**: Successfully configured" >> $GITHUB_STEP_SUMMARY
        else
          echo "⚠️ **Public Access**: Check alternative access methods above" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📋 Project Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Project**: ${{ env.SONAR_PROJECT_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Key**: \`${{ env.SONAR_PROJECT_KEY }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Access Duration**: ${{ env.ACCESS_DURATION }} minutes" >> $GITHUB_STEP_SUMMARY
        echo "- **Authentication**: admin / admin123" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🚀 Workflow Benefits" >> $GITHUB_STEP_SUMMARY
        echo "- **Modular Design**: Uses shared workflows and composite actions" >> $GITHUB_STEP_SUMMARY
        echo "- **Reusable Components**: SonarQube analysis and ngrok setup are reusable" >> $GITHUB_STEP_SUMMARY
        echo "- **Maintainable**: Changes in one place affect all workflows" >> $GITHUB_STEP_SUMMARY
        echo "- **Scalable**: Easy to add more services or environments" >> $GITHUB_STEP_SUMMARY