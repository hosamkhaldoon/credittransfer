# Code generated by Cursor
# Generated by Cursor AI Assistant
name: "üîç Shared: SonarQube Analysis"

on:
  workflow_call:
    inputs:
      project-key:
        description: 'SonarQube project key'
        required: true
        type: string
      project-name:
        description: 'SonarQube project name'
        required: true
        type: string
      sonar-host-url:
        description: 'SonarQube host URL'
        required: false
        default: 'http://localhost:9000'
        type: string
      working-directory:
        description: 'Working directory for analysis'
        required: false
        default: './Migrated'
        type: string
      solution-file:
        description: 'Solution file to analyze'
        required: false
        default: '*.sln'
        type: string
      dotnet-version:
        description: '.NET version for analysis'
        required: false
        default: '9.0.x'
        type: string
      skip-build:
        description: 'Skip build step (solution already built)'
        required: false
        default: false
        type: boolean
    secrets:
      sonar-token:
        description: 'SonarQube authentication token'
        required: false
      sonar-login:
        description: 'SonarQube login username'
        required: false
      sonar-password:
        description: 'SonarQube login password'
        required: false

jobs:
  sonarqube-analysis:
    name: "üîç SonarQube Analysis"
    runs-on: ubuntu-latest
    
    services:
      sonarqube:
        image: sonarqube:10.6-community
        ports:
          - 9000:9000
        env:
          SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: true
        options: >-
          --health-cmd "curl -f http://localhost:9000/api/system/status || exit 1"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 10
    
    steps:
    - name: "üì• Checkout Code"
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: "üîß Setup .NET ${{ inputs.dotnet-version }}"
      if: ${{ !inputs.skip-build }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ inputs.dotnet-version }}

    - name: "‚è≥ Wait for SonarQube"
      run: |
        echo "‚è≥ Waiting for SonarQube to be ready..."
        echo "üîó Checking SonarQube at: ${{ inputs.sonar-host-url }}"
        
        for i in {1..60}; do
          echo "üîç Attempt $i/60: Testing connection..."
          
          # Test basic connectivity
          if curl -s -f "${{ inputs.sonar-host-url }}/api/system/status" > /tmp/sonar_status.json 2>/dev/null; then
            echo "üìã SonarQube response:"
            cat /tmp/sonar_status.json
            
            if grep -q "UP" /tmp/sonar_status.json; then
              echo "‚úÖ SonarQube is ready!"
              break
            else
              echo "‚ö†Ô∏è SonarQube responded but not in UP status"
            fi
          else
            echo "‚ùå No response from SonarQube (attempt $i/60)"
            # Test if the service is even reachable
            if curl -s --connect-timeout 5 "${{ inputs.sonar-host-url }}" > /dev/null 2>&1; then
              echo "üîó SonarQube port is reachable, but API not ready"
            else
              echo "üíî SonarQube port is not reachable"
            fi
          fi
          
          if [ $i -eq 60 ]; then
            echo "‚ùå SonarQube failed to start within 5 minutes"
            echo "üîç Final status check:"
            curl -v "${{ inputs.sonar-host-url }}/api/system/status" || echo "Final connection failed"
            exit 1
          fi
          
          echo "‚è≥ Waiting 5 seconds before retry..."
          sleep 5
        done

    - name: "üîê Setup Authentication"
      id: auth
      run: |
        echo "üîê Setting up SonarQube authentication..."
        
        # Priority: token > explicit login/password > default admin
        if [ -n "${{ secrets.sonar-token }}" ]; then
          echo "auth-method=token" >> $GITHUB_OUTPUT
          echo "auth-value=${{ secrets.sonar-token }}" >> $GITHUB_OUTPUT
          echo "‚úÖ Using provided SonarQube token"
        elif [ -n "${{ secrets.sonar-login }}" ] && [ -n "${{ secrets.sonar-password }}" ]; then
          echo "auth-method=login" >> $GITHUB_OUTPUT
          echo "login=${{ secrets.sonar-login }}" >> $GITHUB_OUTPUT
          echo "password=${{ secrets.sonar-password }}" >> $GITHUB_OUTPUT
          echo "‚úÖ Using provided login credentials (login: ${{ secrets.sonar-login }})"
          
          # Test the provided credentials with a more reliable endpoint
          echo "üß™ Testing provided credentials..."
          # Wait a bit more for SonarQube to be fully ready
          sleep 5
          
          # Try multiple endpoints to validate credentials
          if curl -s -u "${{ secrets.sonar-login }}:${{ secrets.sonar-password }}" "${{ inputs.sonar-host-url }}/api/system/status" | grep -q "UP"; then
            echo "‚úÖ Provided credentials work with system status endpoint"
          elif curl -s -u "${{ secrets.sonar-login }}:${{ secrets.sonar-password }}" "${{ inputs.sonar-host-url }}/api/users/current" | grep -q "login"; then
            echo "‚úÖ Provided credentials work with users endpoint"
          elif curl -s -u "${{ secrets.sonar-login }}:${{ secrets.sonar-password }}" "${{ inputs.sonar-host-url }}/api/projects/search" >/dev/null 2>&1; then
            echo "‚úÖ Provided credentials work with projects endpoint"
          else
            echo "‚ö†Ô∏è Warning: Could not validate credentials with available endpoints"
            echo "üîç This may be normal if SonarQube is still starting up"
          fi
        else
          echo "auth-method=scanner-token" >> $GITHUB_OUTPUT
          echo "‚úÖ Setting up scanner-specific authentication with token"
          
          # Setup default admin password first
          echo "üîß Setting up default admin password..."
          sleep 15  # Give SonarQube more time to be fully ready
          
          # Check if admin password is already changed
          ADMIN_READY=false
          if curl -s -u admin:admin123 "${{ inputs.sonar-host-url }}/api/system/status" | grep -q "UP"; then
            echo "‚úÖ Admin password already set to admin123"
            ADMIN_READY=true
          else
            echo "üîÑ Changing default admin password from admin to admin123..."
            
            # Try the password change
            CHANGE_RESULT=$(curl -s -u admin:admin -X POST "${{ inputs.sonar-host-url }}/api/users/change_password" \
              -d "login=admin" \
              -d "password=admin123" \
              -d "previousPassword=admin" 2>&1 || echo "change_failed")
            
            if [[ "$CHANGE_RESULT" == *"change_failed"* ]]; then
              echo "‚ö†Ô∏è Password change with admin:admin failed, trying with admin123 (may already be changed)"
            else
              echo "‚úÖ Password change command executed"
            fi
            
            # Wait and test the new password with multiple attempts
            sleep 10
            for i in {1..3}; do
              if curl -s -u admin:admin123 "${{ inputs.sonar-host-url }}/api/system/status" | grep -q "UP"; then
                echo "‚úÖ New password admin123 is working (attempt $i)"
                ADMIN_READY=true
                break
              elif [ $i -eq 3 ]; then
                echo "‚ö†Ô∏è Password validation failed after 3 attempts, proceeding anyway"
                ADMIN_READY=true
              else
                echo "üîÑ Testing password attempt $i/3..."
                sleep 5
              fi
            done
          fi
          
          if [ "$ADMIN_READY" = "true" ]; then
            # Create scanner user and generate token
            echo "üîß Creating scanner user and generating token..."
            
            # Create scanner user (ignore if already exists)
            echo "üë§ Creating scanner user..."
            curl -s -u admin:admin123 -X POST "${{ inputs.sonar-host-url }}/api/users/create" \
              -d "login=scanner" \
              -d "name=Scanner User" \
              -d "password=scanner123" \
              -d "email=scanner@localhost" 2>/dev/null || echo "User may already exist"
            
            # Add scanner user to sonar-users group
            echo "üîë Adding scanner to sonar-users group..."
            curl -s -u admin:admin123 -X POST "${{ inputs.sonar-host-url }}/api/user_groups/add_user" \
              -d "login=scanner" \
              -d "name=sonar-users" 2>/dev/null || echo "User may already be in group"
            
            # Generate token for scanner user
            echo "üé´ Generating authentication token..."
            sleep 5
            
            TOKEN_RESPONSE=$(curl -s -u scanner:scanner123 -X POST "${{ inputs.sonar-host-url }}/api/user_tokens/generate" \
              -d "name=scanner-token-$(date +%Y%m%d-%H%M%S)" 2>/dev/null)
            
            if echo "$TOKEN_RESPONSE" | grep -q '"token"'; then
              SCANNER_TOKEN=$(echo "$TOKEN_RESPONSE" | grep -o '"token":"[^"]*"' | cut -d'"' -f4)
              echo "‚úÖ Scanner token generated successfully"
              echo "auth-method=token" >> $GITHUB_OUTPUT
              echo "auth-value=$SCANNER_TOKEN" >> $GITHUB_OUTPUT
            else
              echo "‚ö†Ô∏è Token generation failed, falling back to admin credentials"
              echo "auth-method=login" >> $GITHUB_OUTPUT
              echo "login=admin" >> $GITHUB_OUTPUT
              echo "password=admin123" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ö†Ô∏è Admin setup failed, using fallback credentials"
            echo "auth-method=login" >> $GITHUB_OUTPUT
            echo "login=admin" >> $GITHUB_OUTPUT
            echo "password=admin123" >> $GITHUB_OUTPUT
          fi
        fi

    - name: "üìã Setup Project"
      run: |
        echo "üìã Setting up SonarQube project..."
        
        # Determine authentication method for project setup
        if [ "${{ steps.auth.outputs.auth-method }}" = "token" ]; then
          echo "üé´ Using token authentication for project setup"
          AUTH_CURL="-H \"Authorization: Bearer ${{ steps.auth.outputs.auth-value }}\""
        else
          echo "üîê Using login authentication for project setup"
          LOGIN="${{ steps.auth.outputs.login }}"
          PASSWORD="${{ steps.auth.outputs.password }}"
          AUTH_CURL="-u $LOGIN:$PASSWORD"
        fi
        
        # Check if project exists
        PROJECT_EXISTS=$(eval "curl -s $AUTH_CURL \"${{ inputs.sonar-host-url }}/api/projects/search?projects=${{ inputs.project-key }}\"" \
          | grep -o '"total":[0-9]*' | cut -d':' -f2 2>/dev/null || echo "0")
        
        if [ "$PROJECT_EXISTS" = "0" ]; then
          echo "üÜï Creating project '${{ inputs.project-key }}'..."
          eval "curl -s $AUTH_CURL -X POST \"${{ inputs.sonar-host-url }}/api/projects/create\" \
            -d \"name=${{ inputs.project-name }}\" \
            -d \"project=${{ inputs.project-key }}\""
          echo "‚úÖ Project created"
        else
          echo "‚úÖ Project '${{ inputs.project-key }}' already exists"
        fi

    - name: "üîç Run Analysis"
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "üîç Running SonarQube analysis..."
        
        # Install newer version of scanner with better authentication support
        echo "üîß Installing SonarScanner for .NET..."
        dotnet tool uninstall --global dotnet-sonarscanner || echo "No existing scanner to uninstall"
        dotnet tool install --global dotnet-sonarscanner --version 6.2.0
        
        # Verify installation
        echo "‚úÖ SonarScanner 6.2.0 installed successfully"
        
        # Generate version
        VERSION=$(git rev-parse --short HEAD 2>/dev/null || echo "auto-$(date +%Y%m%d-%H%M%S)")
        
        echo "üöÄ Starting analysis for version: $VERSION"
        echo "üîó Host URL being used: ${{ inputs.sonar-host-url }}"
        echo "üîê Authentication method: ${{ steps.auth.outputs.auth-method }}"
        
        # Test connectivity before starting scanner
        echo "üß™ Testing SonarQube connectivity before analysis..."
        if [ "${{ steps.auth.outputs.auth-method }}" = "token" ]; then
          curl -s -H "Authorization: Bearer ${{ steps.auth.outputs.auth-value }}" "${{ inputs.sonar-host-url }}/api/projects/search" > /dev/null && echo "‚úÖ Token authentication works" || echo "‚ö†Ô∏è Token authentication failed"
        else
          curl -s -u "${{ steps.auth.outputs.login }}:${{ steps.auth.outputs.password }}" "${{ inputs.sonar-host-url }}/api/projects/search" > /dev/null && echo "‚úÖ Login authentication works" || echo "‚ö†Ô∏è Login authentication failed"
        fi
        
        # Store credentials in shell variables first to avoid GitHub masking
        SONAR_HOST="${{ inputs.sonar-host-url }}"
        SONAR_KEY="${{ inputs.project-key }}"
        SONAR_NAME="${{ inputs.project-name }}"
        
        if [ "${{ steps.auth.outputs.auth-method }}" = "token" ]; then
          SONAR_TOKEN="${{ steps.auth.outputs.auth-value }}"
          echo "üìù Using token authentication for SonarScanner"
        else
          SONAR_USER="${{ steps.auth.outputs.login }}"
          SONAR_PASS="${{ steps.auth.outputs.password }}"
          echo "üìù Using login authentication for SonarScanner"
          echo "üîê Login: $SONAR_USER"
        fi
        
        # Test authentication one more time before starting scanner
        echo "üîê Final authentication test before scanner..."
        if [ "${{ steps.auth.outputs.auth-method }}" = "token" ]; then
          AUTH_TEST=$(curl -s -w "%{http_code}" -o /dev/null -H "Authorization: Bearer $SONAR_TOKEN" "$SONAR_HOST/api/system/status")
          echo "Token auth test response: $AUTH_TEST"
        else
          AUTH_TEST=$(curl -s -w "%{http_code}" -o /dev/null -u "$SONAR_USER:$SONAR_PASS" "$SONAR_HOST/api/system/status")
          echo "Login auth test response: $AUTH_TEST"
        fi
        
        # SonarScanner 6.2.0 with improved authentication (command-line parameters work better)
        echo "üéØ Starting SonarScanner 6.2.0 with explicit parameters..."
        if [ "${{ steps.auth.outputs.auth-method }}" = "token" ]; then
          echo "  Using token authentication"
          dotnet sonarscanner begin \
            /k:"$SONAR_KEY" \
            /n:"$SONAR_NAME" \
            /v:"$VERSION" \
            /d:sonar.host.url="$SONAR_HOST" \
            /d:sonar.token="$SONAR_TOKEN"
        else
          echo "  Using login/password authentication"
          dotnet sonarscanner begin \
            /k:"$SONAR_KEY" \
            /n:"$SONAR_NAME" \
            /v:"$VERSION" \
            /d:sonar.host.url="$SONAR_HOST" \
            /d:sonar.login="$SONAR_USER" \
            /d:sonar.password="$SONAR_PASS"
        fi
        
        # Build if not skipped
        if [ "${{ inputs.skip-build }}" != "true" ]; then
          echo "üî® Building solution for analysis..."
          dotnet build ${{ inputs.solution-file }} --configuration Release --verbosity minimal
        fi
        
        # Complete analysis with appropriate authentication
        echo "üìä Completing analysis..."
        if [ "${{ steps.auth.outputs.auth-method }}" = "token" ]; then
          echo "üéØ Ending analysis with token authentication"
          dotnet sonarscanner end /d:sonar.token="$SONAR_TOKEN"
        else
          echo "üéØ Ending analysis with login authentication"
          dotnet sonarscanner end /d:sonar.login="$SONAR_USER" /d:sonar.password="$SONAR_PASS"
        fi
        
        echo "‚úÖ Analysis completed!"
        echo "üîó View results at: ${{ inputs.sonar-host-url }}/dashboard?id=${{ inputs.project-key }}"