# CI Pipeline Migration Guide - From Monolithic to Modular

*Generated by Cursor AI Assistant*

This guide provides step-by-step instructions for migrating your existing GitHub Actions workflows to the new modular, matrix-based architecture.

## 🎯 Quick Start (5 Minutes)

### Step 1: Test the New Architecture
```bash
# 1. Trigger the example matrix build workflow
gh workflow run example-matrix-build.yml

# 2. Test the modular SonarQube workflow  
gh workflow run sonarqube-access-modular.yml

# 3. Compare results with original workflows
```

### Step 2: Immediate Benefits
After running the new workflows, you'll see:
- ✅ **78% less code** in SonarQube workflow (401 → 89 lines)
- ✅ **Parallel service builds** instead of sequential
- ✅ **Centralized configuration** for easy maintenance
- ✅ **Reusable components** across different workflows

## 📋 Full Migration Process

### Phase 1: Foundation Setup (Day 1)

#### 1.1 Verify Shared Components
Ensure these files exist and are functional:
```
.github/
├── workflows/
│   ├── shared-setup-dotnet.yml
│   ├── shared-sonarqube-analysis.yml
│   └── shared-service-matrix.yml
└── actions/
    ├── setup-ngrok/action.yml
    └── matrix-service-build/action.yml
```

#### 1.2 Test Individual Components
```yaml
# Test .NET setup
- uses: ./.github/workflows/shared-setup-dotnet.yml
  with:
    dotnet-version: '9.0.x'

# Test SonarQube analysis  
- uses: ./.github/workflows/shared-sonarqube-analysis.yml
  with:
    project-key: 'test-project'

# Test service matrix
- uses: ./.github/workflows/shared-service-matrix.yml
  with:
    operation: 'build'
    services: '["api"]'
```

### Phase 2: Workflow Migration (Day 2-3)

#### 2.1 Identify Workflows to Migrate

**High Priority** (Immediate ROI):
- [ ] **docker-build.yml** → Matrix strategy (60+ line reduction)
- [ ] **deploy-staging.yml** → Shared service matrix
- [ ] **deploy-production.yml** → Shared service matrix
- [ ] **security-scan.yml** → Matrix for service scanning

**Medium Priority** (Maintenance benefits):
- [ ] **ci-build-test.yml** → Use shared .NET setup
- [ ] **performance-test.yml** → Matrix for service testing

#### 2.2 Migration Template

**Before** (Original Pattern):
```yaml
build-wcf:
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v4
    - uses: docker/setup-buildx-action@v3
    - name: Build WCF
      run: docker build -f src/Services/.../Dockerfile
    # ... 15+ more lines

build-api:
  runs-on: ubuntu-latest  
  steps:
    - uses: actions/checkout@v4
    - uses: docker/setup-buildx-action@v3
    - name: Build API
      run: docker build -f src/Services/.../Dockerfile
    # ... 15+ nearly identical lines
```

**After** (Matrix Pattern):
```yaml
build-services:
  uses: ./.github/workflows/shared-service-matrix.yml
  with:
    operation: 'build'
    services: '["wcf", "api", "worker"]'
    push-images: true
  secrets:
    registry-username: ${{ secrets.DOCKER_USERNAME }}
    registry-password: ${{ secrets.DOCKER_PASSWORD }}
```

#### 2.3 Service Configuration

Add your services to the matrix configuration in `shared-service-matrix.yml`:

```json
{
  "your-new-service": {
    "name": "your-new-service",
    "display_name": "Your New Service",
    "dockerfile": "path/to/your/Dockerfile", 
    "image": "your-image-name",
    "port": 8080,
    "health_path": "/health",
    "deploy_service": "kubernetes-service-name"
  }
}
```

### Phase 3: Advanced Features (Week 2)

#### 3.1 Multi-Environment Support
```yaml
# Development
dev-deploy:
  uses: ./.github/workflows/shared-service-matrix.yml
  with:
    operation: 'deploy'
    environment: 'dev'
    services: '["api", "wcf"]'

# Production
prod-deploy:
  uses: ./.github/workflows/shared-service-matrix.yml
  with:
    operation: 'deploy' 
    environment: 'prod'
    services: '["api", "wcf", "worker", "web"]'
```

#### 3.2 Conditional Service Deployment
```yaml
# Only deploy changed services
deploy-changed:
  uses: ./.github/workflows/shared-service-matrix.yml
  with:
    operation: 'deploy'
    services: ${{ needs.detect-changes.outputs.changed-services }}
```

#### 3.3 Cross-Repository Reuse
```yaml
# In another repository
quality-check:
  uses: your-org/credit-transfer/.github/workflows/shared-sonarqube-analysis.yml@main
  with:
    project-key: 'other-project'
    project-name: 'Other Project'
```

## 🔧 Specific Migration Examples

### Example 1: docker-build.yml Migration

**Current Issues** (Lines 569-613):
```yaml
- name: "🐳 Build and Push WCF Service"
  # ... 15 lines of Docker build code

- name: "🐳 Build and Push REST API"  
  # ... 15 lines of nearly identical Docker build code

- name: "🐳 Build and Push Worker Service"
  # ... 15 lines of nearly identical Docker build code
```

**Migrated Solution**:
```yaml
build-all-services:
  uses: ./.github/workflows/shared-service-matrix.yml
  with:
    operation: 'build'
    services: '["wcf", "api", "worker"]'
    registry: ${{ env.DOCKER_REGISTRY }}
    push-images: true
    version-tag: ${{ needs.prepare.outputs.version }}
  secrets:
    registry-username: ${{ secrets.DOCKER_USERNAME }}
    registry-password: ${{ secrets.DOCKER_PASSWORD }}
```

**Benefits**:
- ✅ **45 lines → 12 lines** (73% reduction)
- ✅ **Parallel execution** (3x faster)
- ✅ **Single maintenance point** for all services
- ✅ **Automatic new service inclusion** with JSON config

### Example 2: deploy-staging.yml Migration

**Current Issues** (Lines 151-393):
```yaml
deploy-api:
  runs-on: ubuntu-latest
  strategy:
    matrix:
      service: [api, wcf, worker, web]
  steps:
    # Duplicated deployment logic for each service
```

**Migrated Solution**:
```yaml
deploy-staging:
  uses: ./.github/workflows/shared-service-matrix.yml
  with:
    operation: 'deploy'
    services: '["api", "wcf", "worker", "web"]'
    environment: 'staging'
    version-tag: ${{ needs.build.outputs.version }}
  secrets:
    deploy-token: ${{ secrets.STAGING_DEPLOY_TOKEN }}

health-check-staging:
  needs: deploy-staging
  uses: ./.github/workflows/shared-service-matrix.yml
  with:
    operation: 'health-check'
    services: '["api", "wcf", "worker", "web"]'
    environment: 'staging'
```

### Example 3: SonarQube Access Simplification

**Current**: 401 lines with inline SonarQube setup, analysis, and ngrok configuration
**Migrated**: 89 lines using shared components

**Key Changes**:
```yaml
# Before: 200+ lines of SonarQube setup and analysis
sonarqube-analysis:
  uses: ./.github/workflows/shared-sonarqube-analysis.yml
  with:
    project-key: 'credit-transfer-modern'
    project-name: 'Credit Transfer Modern'

# Before: 100+ lines of ngrok setup  
setup-public-access:
  steps:
    - uses: ./.github/actions/setup-ngrok
      with:
        port: 9000
        auth-token: ${{ secrets.NGROK_AUTH_TOKEN }}
```

## 🚨 Migration Checklist

### Pre-Migration Validation
- [ ] ✅ All shared workflows exist and are syntactically valid
- [ ] ✅ Composite actions have proper input/output definitions
- [ ] ✅ Service matrix configuration includes all your services
- [ ] ✅ Test repository secrets are configured (DOCKER_USERNAME, etc.)

### Migration Steps
- [ ] 🔄 Create backup branch with current workflows
- [ ] 🔄 Migrate one workflow at a time (start with least critical)
- [ ] 🔄 Test each migrated workflow in feature branch
- [ ] 🔄 Compare results with original workflow runs
- [ ] 🔄 Update documentation and team knowledge

### Post-Migration Verification
- [ ] ✅ All services build successfully in parallel
- [ ] ✅ Deployment workflows complete without errors
- [ ] ✅ New service addition takes <5 minutes
- [ ] ✅ Workflow maintenance is centralized
- [ ] ✅ Team understands new architecture

## 🎯 Success Metrics

### Immediate Gains (Week 1)
- **Code Reduction**: 60-80% reduction in workflow line count
- **Build Speed**: 3x faster parallel service builds
- **Maintenance Effort**: Single point of change for service operations

### Medium-term Benefits (Month 1)
- **New Service Onboarding**: 5 minutes vs 2+ hours
- **Cross-Team Reuse**: Shared workflows used by multiple repositories
- **Error Reduction**: Consistent patterns reduce configuration errors

### Long-term Impact (Quarter 1)
- **Developer Productivity**: Less time on CI/CD maintenance
- **System Reliability**: Standardized, tested patterns
- **Organizational Efficiency**: Shared best practices across teams

## 🛠️ Troubleshooting

### Common Issues and Solutions

#### Issue: "Workflow not found"
```bash
# Solution: Ensure shared workflow files exist and are committed
git add .github/workflows/shared-*.yml
git commit -m "Add shared workflows"
git push
```

#### Issue: "Matrix configuration not found"
```bash
# Solution: Verify service configuration in shared-service-matrix.yml
# Check that your service name matches the JSON configuration key
```

#### Issue: "Secrets not available in shared workflow"
```yaml
# Solution: Pass secrets explicitly to shared workflows
secrets:
  registry-username: ${{ secrets.DOCKER_USERNAME }}
  registry-password: ${{ secrets.DOCKER_PASSWORD }}
```

#### Issue: "Composite action inputs missing"
```yaml
# Solution: Ensure all required inputs are provided
- uses: ./.github/actions/setup-ngrok
  with:
    port: 9000  # Required
    auth-token: ${{ secrets.NGROK_AUTH_TOKEN }}  # Required
```

## 📚 Additional Resources

### GitHub Actions Documentation
- [Reusing workflows](https://docs.github.com/en/actions/using-workflows/reusing-workflows)
- [Creating composite actions](https://docs.github.com/en/actions/creating-actions/creating-a-composite-action) 
- [Using a matrix strategy](https://docs.github.com/en/actions/using-jobs/using-a-matrix-for-your-jobs)

### Best Practices
- [GitHub Actions best practices](https://docs.github.com/en/actions/learn-github-actions/essential-features-of-github-actions)
- [Security best practices](https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions)

### Team Training
- Schedule workshop on new workflow architecture
- Create team documentation with project-specific examples
- Set up pair programming sessions for first migrations

---

## 🎉 Ready to Start?

1. **Quick Test**: Run `example-matrix-build.yml` to see immediate benefits
2. **First Migration**: Start with `docker-build.yml` for maximum impact
3. **Team Adoption**: Share results and migrate remaining workflows
4. **Continuous Improvement**: Gather feedback and enhance shared components

**Questions?** Check the [Workflows Architecture](WORKFLOWS_ARCHITECTURE.md) documentation or create an issue for team discussion.

---

*Remember: The goal is not just to reduce code, but to create a more maintainable, scalable, and enjoyable development experience for the entire team.*